schema: '2.0'
stages:
  data_validation:
    cmd: python3 src/data/data_validation.py
    deps:
    - path: src/data/data_validation.py
      hash: md5
      md5: c22ed8ca8c2bc71f425b486185ddd672
      size: 3217
    - path: src/utils.py
      hash: md5
      md5: 86cb617a88a0a0103e71212cd04402ba
      size: 3700
    params:
      params.yaml:
        data_validation.columns_num:
        - Passenger_Count
        - Trip_Distance
        - Start_Lon
        - Start_Lat
        - End_Lon
        - End_Lat
        - Fare_Amt
        - Total_Amt
        data_validation.columns_required:
        - Trip_Pickup_DateTime
        - Trip_Dropoff_DateTime
        - Passenger_Count
        - Trip_Distance
        - Start_Lon
        - Start_Lat
        - End_Lon
        - End_Lat
        - Fare_Amt
        - Total_Amt
        data_validation.columns_str:
        - Trip_Pickup_DateTime
        - Trip_Dropoff_DateTime
    outs:
    - path: outputs/dummy_Validation_complete.json
      hash: md5
      md5: 0d7ac2dec5f281678f65dcf7fe4681ba
      size: 16
  data_ingestion:
    cmd: python3 src/data/data_ingestion.py
    deps:
    - path: outputs/dummy_Validation_complete.json
      hash: md5
      md5: 0d7ac2dec5f281678f65dcf7fe4681ba
      size: 16
    - path: src/data/data_ingestion.py
      hash: md5
      md5: c7051dc4c4d549ee0930851fd5ae5895
      size: 7817
    - path: src/utils.py
      hash: md5
      md5: 86cb617a88a0a0103e71212cd04402ba
      size: 3700
    params:
      params.yaml:
        data_ingestion.columns_datetime:
        - Trip_Pickup_DateTime
        - Trip_Dropoff_DateTime
        data_ingestion.columns_required:
        - Trip_Pickup_DateTime
        - Trip_Dropoff_DateTime
        - Passenger_Count
        - Trip_Distance
        - Start_Lon
        - Start_Lat
        - End_Lon
        - End_Lat
        - Fare_Amt
        - Total_Amt
    outs:
    - path: data/raw
      hash: md5
      md5: 45ea71d54934762017fc667ac751ea92.dir
      size: 985591605
      nfiles: 3
  data_preprocessing:
    cmd: python3 src/data/data_preprocessing.py
    deps:
    - path: data/raw/test.parquet
      hash: md5
      md5: 8549d5c297758a32c002ad05b2819083
      size: 169990860
    - path: data/raw/train.parquet
      hash: md5
      md5: be84f6ecfe1f6c9c7b2223ae26a014e5
      size: 643301971
    - path: data/raw/val.parquet
      hash: md5
      md5: eb7db605c093c543a8df4c780c0fa853
      size: 172298774
    - path: src/data/data_preprocessing.py
      hash: md5
      md5: 673e4f80ae7eff44de611b82db3f0943
      size: 16743
    - path: src/utils.py
      hash: md5
      md5: 86cb617a88a0a0103e71212cd04402ba
      size: 3700
    params:
      params.yaml:
        data_preprocessing.filters:
          real_time: true
          trip_distance: true
          real_velocity_limit: 300
          real_time_days: 32
          constant_vel_limit:
          - 30
          - 100
          - 56
          distance_limit: 800
          haversine_ratio_limit: 80
          ratio_distance_list:
          - - 40
            - 0.8
          - - 15
            - 5
          - - 3
            - 1
          - - 4
            - 0.5
        data_preprocessing.imputer_method: simpleimputer
        data_preprocessing.scaler_method: standardscaler
    outs:
    - path: data/processed
      hash: md5
      md5: ffc62f08b0777ba7d26b67c75b382420.dir
      size: 2892122592
      nfiles: 3
  data_osrm:
    cmd: python3 src/data/data_osrm.py
    deps:
    - path: data/processed/test_processed.parquet
      hash: md5
      md5: 6cb05771debdb1d8bf5b94b425aca533
      size: 501977886
    - path: data/processed/train_processed.parquet
      hash: md5
      md5: 3bf3e0f37dc6e919bc1ef9c358cf144a
      size: 1888745466
    - path: data/processed/val_processed.parquet
      hash: md5
      md5: 783564e5c5be2310c471f5f83a35bb76
      size: 501399240
    - path: src/data/data_osrm.py
      hash: md5
      md5: 91407136c282579686aeaacf4957c402
      size: 8269
    - path: src/osrm_console.py
      hash: md5
      md5: 6b1a2af73ba7e1f30df7f9403f4b97cf
      size: 7076
    - path: src/utils.py
      hash: md5
      md5: 86cb617a88a0a0103e71212cd04402ba
      size: 3700
    params:
      params.yaml:
        data_osrm.osrm:
          add_osrm: true
          osrm_base: http://127.0.0.1:5000/route/v1/driving
          concurrency: 180
          chunk_size: 400000
    outs:
    - path: data/processed_osrm
      hash: md5
      md5: 218db4d5923efe086fa0fdbb6f610773.dir
      size: 3404065815
      nfiles: 3
  train_lgbm:
    cmd: python3 src/model/train_lgbm.py
    deps:
    - path: data/processed_osrm/train_processed_osrm.parquet
      hash: md5
      md5: 02392656fc40aff35798884c34355b46
      size: 2221948612
    - path: src/model/train_lgbm.py
      hash: md5
      md5: a8188c90dca722a291df512886db120d
      size: 3671
    - path: src/utils.py
      hash: md5
      md5: 86cb617a88a0a0103e71212cd04402ba
      size: 3700
    params:
      params.yaml:
        model_building.models.lgbm:
          class: lightgbm.LGBMRegressor
          params:
            n_estimators: 400
            learning_rate: 0.08
            max_depth: 8
            random_state: 42
            objective: regression
            metric: rmse
            verbosity: 1
            n_jobs: -1
        model_building.target: Fare_Amt
    outs:
    - path: models/saved_models/lgbm_model.pkl
      hash: md5
      md5: 73758243c247856d9076a559d7449803
      size: 1278298
    - path: models/saved_models/lgbm_model_feature_importances.csv
      hash: md5
      md5: ee3a9ae613f4332db50ffc11cd42f937
      size: 644
    - path: models/saved_models/lgbm_model_meta.json
      hash: md5
      md5: 75eb60aa76b41fda0ac8acc796c5b36b
      size: 587
  train_xgboost:
    cmd: python3 src/model/train_xgboost.py
    deps:
    - path: data/processed_osrm/train_processed_osrm.parquet
      hash: md5
      md5: 02392656fc40aff35798884c34355b46
      size: 2221948612
    - path: src/model/train_xgboost.py
      hash: md5
      md5: cf60070499e83317764572a1b225a8ba
      size: 3475
    - path: src/utils.py
      hash: md5
      md5: 86cb617a88a0a0103e71212cd04402ba
      size: 3700
    params:
      params.yaml:
        model_building.models.xgboost:
          class: xgboost.XGBRegressor
          params:
            n_estimators: 550
            max_depth: 8
            tree_method: hist
            learning_rate: 0.09
            subsample: 0.8
            random_state: 42
            objective: reg:squarederror
            device: cuda
        model_building.target: Fare_Amt
    outs:
    - path: models/saved_models/xgboost_model.pkl
      hash: md5
      md5: c9c03d3836ef08a152b62d09ec971516
      size: 8573562
    - path: models/saved_models/xgboost_model_feature_importances.csv
      hash: md5
      md5: 3627af0c3c7138b02ca092811e21e631
      size: 865
    - path: models/saved_models/xgboost_model_meta.json
      hash: md5
      md5: 758b26772e58fd6f197b246360ba974f
      size: 611
  train_catboost:
    cmd: python3 src/model/train_catboost.py
    deps:
    - path: data/processed_osrm/train_processed_osrm.parquet
      hash: md5
      md5: 02392656fc40aff35798884c34355b46
      size: 2221948612
    - path: src/model/train_catboost.py
      hash: md5
      md5: 2bbd29b9e39ffc4b51c2e47ae531d6e9
      size: 7105
    - path: src/utils.py
      hash: md5
      md5: 86cb617a88a0a0103e71212cd04402ba
      size: 3700
    params:
      params.yaml:
        model_building.models.catboost:
          class: catboost.CatBoostRegressor
          params:
            iterations: 600
            learning_rate: 0.08
            depth: 8
            random_seed: 42
            task_type: GPU
            devices: '0'
            loss_function: RMSE
            eval_metric: RMSE
        model_building.target: Fare_Amt
    outs:
    - path: models/saved_models/catboost_model.cbm
      hash: md5
      md5: b2a870c734e67be86238cc04760c5f6f
      size: 2531064
    - path: models/saved_models/catboost_model_feature_importances.csv
      hash: md5
      md5: e5c5bb2684dce35263c68b9faa534961
      size: 1029
    - path: models/saved_models/catboost_model_meta.json
      hash: md5
      md5: 7d97780fbecbd6e4beb9bf85bb2da45d
      size: 605
  train_stacking:
    cmd: python3 src/model/train_stacking.py
    deps:
    - path: data/processed_osrm/train_processed_osrm.parquet
      hash: md5
      md5: 02392656fc40aff35798884c34355b46
      size: 2221948612
    - path: models/saved_models/catboost_model.cbm
      hash: md5
      md5: b2a870c734e67be86238cc04760c5f6f
      size: 2531064
    - path: models/saved_models/lgbm_model.pkl
      hash: md5
      md5: 73758243c247856d9076a559d7449803
      size: 1278298
    - path: models/saved_models/xgboost_model.pkl
      hash: md5
      md5: c9c03d3836ef08a152b62d09ec971516
      size: 8573562
    - path: src/model/train_stacking.py
      hash: md5
      md5: 8b157544ebdf3c1dabf324dd2a13bdd6
      size: 6475
    - path: src/utils.py
      hash: md5
      md5: 86cb617a88a0a0103e71212cd04402ba
      size: 3700
    params:
      params.yaml:
        model_building.meta_model:
          class: sklearn.linear_model.Ridge
          params:
            alpha: 1.2
            fit_intercept: true
            solver: auto
            random_state: 42
            max_iter: 1000
        model_building.meta_train_frac: 0.8
        model_building.target: Fare_Amt
    outs:
    - path: models/saved_models/stacking_meta_coefs.csv
      hash: md5
      md5: 1ba345e44948880ed843bdbc4cac23a6
      size: 145
    - path: models/saved_models/stacking_meta_model.pkl
      hash: md5
      md5: ce44be2b24ed8e8e7a79fbfefebed6cf
      size: 881
  model_evaluation:
    cmd: python3 src/model/model_evaluation.py
    deps:
    - path: data/processed_osrm/test_processed_osrm.parquet
      hash: md5
      md5: 37696ee655f524998504760af9af7514
      size: 591193145
    - path: data/processed_osrm/val_processed_osrm.parquet
      hash: md5
      md5: 579376050b779338b363595fbae61f89
      size: 590924058
    - path: models/saved_models/catboost_model.cbm
      hash: md5
      md5: b2a870c734e67be86238cc04760c5f6f
      size: 2531064
    - path: models/saved_models/catboost_model_feature_importances.csv
      hash: md5
      md5: e5c5bb2684dce35263c68b9faa534961
      size: 1029
    - path: models/saved_models/catboost_model_meta.json
      hash: md5
      md5: 7d97780fbecbd6e4beb9bf85bb2da45d
      size: 605
    - path: models/saved_models/lgbm_model.pkl
      hash: md5
      md5: 73758243c247856d9076a559d7449803
      size: 1278298
    - path: models/saved_models/lgbm_model_feature_importances.csv
      hash: md5
      md5: ee3a9ae613f4332db50ffc11cd42f937
      size: 644
    - path: models/saved_models/lgbm_model_meta.json
      hash: md5
      md5: 75eb60aa76b41fda0ac8acc796c5b36b
      size: 587
    - path: models/saved_models/stacking_meta_coefs.csv
      hash: md5
      md5: 1ba345e44948880ed843bdbc4cac23a6
      size: 145
    - path: models/saved_models/stacking_meta_model.pkl
      hash: md5
      md5: ce44be2b24ed8e8e7a79fbfefebed6cf
      size: 881
    - path: models/saved_models/xgboost_model.pkl
      hash: md5
      md5: c9c03d3836ef08a152b62d09ec971516
      size: 8573562
    - path: models/saved_models/xgboost_model_feature_importances.csv
      hash: md5
      md5: 3627af0c3c7138b02ca092811e21e631
      size: 865
    - path: models/saved_models/xgboost_model_meta.json
      hash: md5
      md5: 758b26772e58fd6f197b246360ba974f
      size: 611
    - path: src/model/model_evaluation.py
      hash: md5
      md5: 33ff3c439cd1c4cb7f56f66d7fb21d2b
      size: 25885
    - path: src/utils.py
      hash: md5
      md5: 86cb617a88a0a0103e71212cd04402ba
      size: 3700
    params:
      params.yaml:
        model_evaluation.experiment_name: taxi-fare-prediction
        model_evaluation.metrics_dir: models/metrics
        model_evaluation.models_dir: models/saved_models
        model_evaluation.output_final_dir: flask_app/models/v1
        model_evaluation.selection:
          mode: overall
          weights:
            rmse: 0.5
            mae: 0.25
            r2: 0.05
            mape: 0.1
            medae: 0.1
        model_evaluation.target: Fare_Amt
        model_evaluation.test_path: 
          data/processed_osrm/test_processed_osrm.parquet
        model_evaluation.tracking_uri: 
          https://dagshub.com/takenking9879/MLOPS-project-NYC-Taxi-Fare-Prediction.mlflow
        model_evaluation.val_path: 
          data/processed_osrm/val_processed_osrm.parquet
    outs:
    - path: models/metrics/
      hash: md5
      md5: 51fa3abeadb6428bb45f61dd22789aa8.dir
      size: 1307
      nfiles: 5
  data_download:
    cmd: python3 src/CT/data_download.py
    deps:
    - path: src/CT/data_download.py
      hash: md5
      md5: 8861dae49b5a84da8b77acbc699024e5
      size: 3115
    - path: src/utils.py
      hash: md5
      md5: f1691055540956d368120a3ed81abac8
      size: 2391
    params:
      params.yaml:
        continous_training.data_download.month: 3
        continous_training.data_download.year: 2009
    outs:
    - path: new_data/original/
      hash: md5
      md5: d751713988987e9331980363e24189ce.dir
      size: 0
      nfiles: 0
  data_validation_ct:
    cmd: python3 src/CT/data/data_validation_ct.py
    deps:
    - path: new_data/original/
      hash: md5
      md5: 08b7d50e2a4904cdc8a68c809c461b93.dir
      size: 1456048316
      nfiles: 3
    - path: src/CT/data/data_validation_ct.py
      hash: md5
      md5: e8eb35113b051614a397f630ee4f4546
      size: 2177
    - path: src/utils.py
      hash: md5
      md5: 86cb617a88a0a0103e71212cd04402ba
      size: 3700
    params:
      params.yaml:
        continuous_training.data_validation_ct.columns_num:
        - Passenger_Count
        - Trip_Distance
        - Start_Lon
        - Start_Lat
        - End_Lon
        - End_Lat
        - Fare_Amt
        - Total_Amt
        continuous_training.data_validation_ct.columns_required:
        - Trip_Pickup_DateTime
        - Trip_Dropoff_DateTime
        - Passenger_Count
        - Trip_Distance
        - Start_Lon
        - Start_Lat
        - End_Lon
        - End_Lat
        - Fare_Amt
        - Total_Amt
        continuous_training.data_validation_ct.columns_str:
        - Trip_Pickup_DateTime
        - Trip_Dropoff_DateTime
        continuous_training.retrain: true
    outs:
    - path: outputs/dummy_ValidationCT_complete.json
      hash: md5
      md5: 0d7ac2dec5f281678f65dcf7fe4681ba
      size: 16
  data_download_ct:
    cmd: python3 src/CT/data/data_download_ct.py
    deps:
    - path: models/metrics/
      hash: md5
      md5: 51fa3abeadb6428bb45f61dd22789aa8.dir
      size: 1307
      nfiles: 5
    - path: src/CT/data/data_download_ct.py
      hash: md5
      md5: 98781eb79ab87cc3efe251517efae1c4
      size: 3208
    - path: src/utils.py
      hash: md5
      md5: 86cb617a88a0a0103e71212cd04402ba
      size: 3700
    params:
      params.yaml:
        continuous_training.data_download_ct.month: 3
        continuous_training.data_download_ct.year: 2009
        continuous_training.retrain: true
    outs:
    - path: new_data/original/
      hash: md5
      md5: 08b7d50e2a4904cdc8a68c809c461b93.dir
      size: 1456048316
      nfiles: 3
  data_ingestion_ct:
    cmd: python3 src/CT/data/data_ingestion_ct.py
    deps:
    - path: outputs/dummy_ValidationCT_complete.json
      hash: md5
      md5: 0d7ac2dec5f281678f65dcf7fe4681ba
      size: 16
    - path: src/CT/data/data_ingestion_ct.py
      hash: md5
      md5: fe873ad67bebc65408fa24cb679a9c15
      size: 6404
    - path: src/utils.py
      hash: md5
      md5: 86cb617a88a0a0103e71212cd04402ba
      size: 3700
    params:
      params.yaml:
        continuous_training.data_ingestion_ct.columns_datetime:
        - Trip_Pickup_DateTime
        - Trip_Dropoff_DateTime
        continuous_training.data_ingestion_ct.columns_required:
        - Trip_Pickup_DateTime
        - Trip_Dropoff_DateTime
        - Passenger_Count
        - Trip_Distance
        - Start_Lon
        - Start_Lat
        - End_Lon
        - End_Lat
        - Fare_Amt
        - Total_Amt
        continuous_training.retrain: true
    outs:
    - path: new_data/raw/
      hash: md5
      md5: a0b027c5a4d82e1cffda4a1dac51b8c0.dir
      size: 1025486957
      nfiles: 3
  data_preprocessing_ct:
    cmd: python3 src/CT/data/data_preprocessing_ct.py
    deps:
    - path: new_data/raw/
      hash: md5
      md5: a0b027c5a4d82e1cffda4a1dac51b8c0.dir
      size: 1025486957
      nfiles: 3
    - path: src/CT/data/data_preprocessing_ct.py
      hash: md5
      md5: 4eaa95f503b4753e6a48d8e128e7f94a
      size: 6102
    - path: src/utils.py
      hash: md5
      md5: 86cb617a88a0a0103e71212cd04402ba
      size: 3700
    params:
      params.yaml:
        continuous_training.data_preprocessing_ct.filters:
          real_time: true
          trip_distance: true
          real_velocity_limit: 300
          real_time_days: 32
          constant_vel_limit:
          - 30
          - 100
          - 56
          distance_limit: 800
          haversine_ratio_limit: 80
          ratio_distance_list:
          - - 40
            - 0.8
          - - 15
            - 5
          - - 3
            - 1
          - - 4
            - 0.5
        continuous_training.retrain: true
    outs:
    - path: new_data/processed/
      hash: md5
      md5: 493999eac4f982cb036a7c45ba8f6c8c.dir
      size: 3002978299
      nfiles: 3
  data_osrm_ct:
    cmd: python3 src/CT/data/data_osrm_ct.py
    deps:
    - path: new_data/processed/
      hash: md5
      md5: 493999eac4f982cb036a7c45ba8f6c8c.dir
      size: 3002978299
      nfiles: 3
    - path: src/CT/data/data_osrm_ct.py
      hash: md5
      md5: 7139b08a1a1469e1e5c3c8ebb7dc70ee
      size: 5566
    - path: src/osrm_console.py
      hash: md5
      md5: 6b1a2af73ba7e1f30df7f9403f4b97cf
      size: 7076
    - path: src/utils.py
      hash: md5
      md5: 86cb617a88a0a0103e71212cd04402ba
      size: 3700
    params:
      params.yaml:
        continuous_training.data_osrm_ct.osrm:
          add_osrm: true
          osrm_base: http://127.0.0.1:5000/route/v1/driving
          concurrency: 200
          chunk_size: 400000
    outs:
    - path: new_data/processed_osrm/
      hash: md5
      md5: e58789b07dc75b2e781d8e2294dc49e1.dir
      size: 3537332525
      nfiles: 3
  model_retraining:
    cmd: python3 src/CT/model/model_retraining.py
    deps:
    - path: new_data/processed_osrm/
      hash: md5
      md5: e58789b07dc75b2e781d8e2294dc49e1.dir
      size: 3537332525
      nfiles: 3
    - path: src/CT/model/model_retraining.py
      hash: md5
      md5: eaa7e80bcb5df6f090265bfb8a0a0ca9
      size: 9979
    - path: src/utils.py
      hash: md5
      md5: 86cb617a88a0a0103e71212cd04402ba
      size: 3700
    params:
      params.yaml:
        continuous_training.model_retraining.meta_alpha: 0.5
        continuous_training.model_retraining.oof_folds: 5
        continuous_training.model_retraining.target: Fare_Amt
    outs:
    - path: new_model/
      hash: md5
      md5: 04b232cb77c31fc61505681fc6b39937.dir
      size: 8690531
      nfiles: 3
  model_promotion:
    cmd: python3 src/CT/model/model_promotion.py
    deps:
    - path: new_model/
      hash: md5
      md5: 04b232cb77c31fc61505681fc6b39937.dir
      size: 8690531
      nfiles: 3
    - path: src/CT/model/model_promotion.py
      hash: md5
      md5: 52152dda0631a303e8a808467a5c1c36
      size: 17799
    - path: src/utils.py
      hash: md5
      md5: 86cb617a88a0a0103e71212cd04402ba
      size: 3700
    params:
      params.yaml:
        continuous_training.model_promotion.evaluate_all_in_test: true
        continuous_training.model_promotion.metric_to_compare: rmse
        continuous_training.model_promotion.target: Fare_Amt
